



<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
      
        <link rel="canonical" href="https://automate.guru/multi-stage-yaml-pipeline-configuration/">
      
      
      
        <meta name="lang:clipboard.copy" content="Copy to clipboard">
      
        <meta name="lang:clipboard.copied" content="Copied to clipboard">
      
        <meta name="lang:search.language" content="en">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="No matching documents">
      
        <meta name="lang:search.result.one" content="1 matching document">
      
        <meta name="lang:search.result.other" content="# matching documents">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.1, mkdocs-material-4.6.3">
    
    
      
        <title>Multi-Stage YAML Pipeline Configuration - Automation Bible</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/application.adb8469c.css">
      
        <link rel="stylesheet" href="../assets/stylesheets/application-palette.a8b3c06d.css">
      
      
        
        
        <meta name="theme-color" content="#2196f3">
      
    
    
      <script src="../assets/javascripts/modernizr.86422ebf.js"></script>
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CUbuntu+Mono&display=fallback">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Ubuntu Mono","Courier New",Courier,monospace}</style>
      
    
    <link rel="stylesheet" href="../assets/fonts/material-icons.css">
    
    
    
      
        
<script>
  window.ga = window.ga || function() {
    (ga.q = ga.q || []).push(arguments)
  }
  ga.l = +new Date
  /* Setup integration and send page view */
  ga("create", "UA-160963982-1", "auto")
  ga("set", "anonymizeIp", true)
  ga("send", "pageview")
  /* Register handler to log search on blur */
  document.addEventListener("DOMContentLoaded", () => {
    if (document.forms.search) {
      var query = document.forms.search.query
      query.addEventListener("blur", function() {
        if (this.value) {
          var path = document.location.pathname;
          ga("send", "pageview", path + "?q=" + this.value)
        }
      })
    }
  })
</script>
<script async src="https://www.google-analytics.com/analytics.js"></script>
      
    
    
  </head>
  
    
    
    <body dir="ltr" data-md-color-primary="blue" data-md-color-accent="blue">
  
    <svg class="md-svg">
      <defs>
        
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
    
      <a href="#multi-stage-yaml-pipeline-configuration" tabindex="0" class="md-skip">
        Skip to content
      </a>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href="https://automate.guru/" title="Automation Bible" aria-label="Automation Bible" class="md-header-nav__button md-logo">
          
            <i class="md-icon"></i>
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            <span class="md-header-nav__topic">
              Automation Bible
            </span>
            <span class="md-header-nav__topic">
              
                Multi-Stage YAML Pipeline Configuration
              
            </span>
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
          
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" aria-label="search" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
        
      </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
      <main class="md-main" role="main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href="https://automate.guru/" title="Automation Bible" class="md-nav__button md-logo">
      
        <i class="md-icon"></i>
      
    </a>
    Automation Bible
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href="../azure-devops-audit-logs-forwarding/" title="Azure DevOps Audit Logs Forwarder" class="md-nav__link">
      Azure DevOps Audit Logs Forwarder
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../azure-lighthouse-configuration/" title="Azure Lighthouse Configuration" class="md-nav__link">
      Azure Lighthouse Configuration
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../powershell-web-browser-automation/" title="Powershell Web-Based Automation" class="md-nav__link">
      Powershell Web-Based Automation
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../copy-database-between-stages/" title="Copy Azure database between stages" class="md-nav__link">
      Copy Azure database between stages
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../security-and-compliance-as-a-code-azure-policy-tdd/" title="Security And Compliance As A Code Azure Policy TDD" class="md-nav__link">
      Security And Compliance As A Code Azure Policy TDD
    </a>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        Multi-Stage YAML Pipeline Configuration
      </label>
    
    <a href="./" title="Multi-Stage YAML Pipeline Configuration" class="md-nav__link md-nav__link--active">
      Multi-Stage YAML Pipeline Configuration
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#ok-but-why-i-should-use-it-if-i-can-easly-click-everything-in-portal" class="md-nav__link">
    Ok, but why I should use it if I can easly click everything in portal?
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#sounds-good-but-what-if-i-dont-have-experience-with-yaml-language" class="md-nav__link">
    Sounds good, but what if I don't have experience with YAML language?
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#how-to-get-started-with-multi-stage-yaml-pipelines" class="md-nav__link">
    How to get started with Multi-Stage YAML pipelines?
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#prerequisites" class="md-nav__link">
    Prerequisites
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#yaml-configuration" class="md-nav__link">
    YAML configuration
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#build-configuration" class="md-nav__link">
    Build configuration
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#deploy-to-all-stagesyaml-configuration" class="md-nav__link">
    deploy-to-all-stages.yaml configuration
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#deployment-stageyaml-configuration" class="md-nav__link">
    deployment-stage.yaml configuration
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#linking-a-build-yaml-file-in-azure-devops" class="md-nav__link">
    Linking a build yaml file in Azure DevOps
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#conclusion" class="md-nav__link">
    Conclusion
  </a>
  
</li>
      
      
      
      
      
        <li class="md-nav__item">
          <a href="#__comments" class="md-nav__link md-nav__link--active">
            Comments
          </a>
        </li>
      
    </ul>
  
</nav>
    
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../azure-policy-continous-integration/" title="Continous Inspection For Azure Policy" class="md-nav__link">
      Continous Inspection For Azure Policy
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../automatic-certificate-generation-aks/" title="Automatic Certificate Generation for AKS" class="md-nav__link">
      Automatic Certificate Generation for AKS
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../management-group-best-practises/" title="Azure Management Group Hierarchy Best Practises" class="md-nav__link">
      Azure Management Group Hierarchy Best Practises
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../universal-arm-deployment-script" title="Universal ARM Template Deployment Script" class="md-nav__link">
      Universal ARM Template Deployment Script
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../ensure-policy-assignment-msi-permission-for-mg/" title="XXX" class="md-nav__link">
      XXX
    </a>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#ok-but-why-i-should-use-it-if-i-can-easly-click-everything-in-portal" class="md-nav__link">
    Ok, but why I should use it if I can easly click everything in portal?
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#sounds-good-but-what-if-i-dont-have-experience-with-yaml-language" class="md-nav__link">
    Sounds good, but what if I don't have experience with YAML language?
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#how-to-get-started-with-multi-stage-yaml-pipelines" class="md-nav__link">
    How to get started with Multi-Stage YAML pipelines?
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#prerequisites" class="md-nav__link">
    Prerequisites
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#yaml-configuration" class="md-nav__link">
    YAML configuration
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#build-configuration" class="md-nav__link">
    Build configuration
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#deploy-to-all-stagesyaml-configuration" class="md-nav__link">
    deploy-to-all-stages.yaml configuration
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#deployment-stageyaml-configuration" class="md-nav__link">
    deployment-stage.yaml configuration
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#linking-a-build-yaml-file-in-azure-devops" class="md-nav__link">
    Linking a build yaml file in Azure DevOps
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#conclusion" class="md-nav__link">
    Conclusion
  </a>
  
</li>
      
      
      
      
      
        <li class="md-nav__item">
          <a href="#__comments" class="md-nav__link md-nav__link--active">
            Comments
          </a>
        </li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                
                <h1 id="multi-stage-yaml-pipeline-configuration">Multi-Stage YAML Pipeline Configuration</h1>
<p><img alt="Multi-Stage YAML result" src="../img/multi-stage-yaml-pipeline-configuration-009.jpg" /></p>
<p>Since May 2019 Microsoft offer as a part of Azure DevOps service Multi-Stage YAML pipelines.
Probably you will ask what is a difference between standard approach of CICD process and Multi-Stage?
Answer is pretty simple - in standard approach only CI (build) part of CICD process was possible to define as YAML definition.
Multi-Stage YAML pipelines (name of it is bacially self explanatory) approach allows to define both CI (build) and CD(release) processes in YAML language.</p>
<h2 id="ok-but-why-i-should-use-it-if-i-can-easly-click-everything-in-portal">Ok, but why I should use it if I can easly click everything in portal?</h2>
<p>Of course you can do everything via GUI, but common why not take one step forward and define your pipeline as a code?
How cool it can be if you are defining not only infrastructure as a code but also your whole CICD process?</p>
<p>If I didn't encourage you yet to using this funcionality, below you can find more advantages of using it:</p>
<ul>
<li>
<p><strong>Diff option</strong> - you can compare the definition which are failing with the last known good configuration.</p>
</li>
<li>
<p><strong>History</strong> - source control allows you to see every change which was done to your pipeline since the initial creation.</p>
</li>
<li>
<p><strong>Rollback</strong> - if you found that your last commit causing any problem during deployment, simple roll it back to last good configuration.</p>
</li>
<li>
<p><strong>Reusability option</strong> - how often you wanted to reuse pipeline which is already defined? - now you can simply do that by copy/paste option.</p>
</li>
<li>
<p><strong>Team cooperation</strong> - if there are multiple people working on same pipeline it can cause problem using GUI, using YAML team members can work on separate branch and adjust definition according to their needs.</p>
</li>
</ul>
<h2 id="sounds-good-but-what-if-i-dont-have-experience-with-yaml-language">Sounds good, but what if I don't have experience with YAML language?</h2>
<p>If you think it is problem you are totally wrong.
YAML is not complicated - if you ever define Azure resource definition using Azure Resource Manager (ARM template) you will for sure be able to easily write YAML pipelines.</p>
<h2 id="how-to-get-started-with-multi-stage-yaml-pipelines">How to get started with Multi-Stage YAML pipelines?</h2>
<p>Let me guide you step by step how to configure such pipeline.</p>
<p>In my example I will show you how to configure Azure Kubernetes Service with some additional tools which are usefull during application deployment.</p>
<p>Later you can adjust it to your needs by changing specific task - however overall process of creation will be basically the same.</p>
<h3 id="prerequisites">Prerequisites</h3>
<p>In my scenario I will shouw you how to setup additional tools on <strong>Azure Kubernetes Service cluster</strong>.
Following prerequisites should be met:</p>
<ul>
<li>At least one AKS cluster should be created</li>
<li>Proper permission assigned for AKS cluster - best to have Owner</li>
</ul>
<p><img alt="AKS-Clusters" src="../img/multi-stage-yaml-pipeline-configuration-002.jpg" /></p>
<p>In first step we need to define environment in Azure Dev Ops for each cluster.
Go to <strong>Pipeline-&gt;Environment-&gt;Create Environment</strong>
Type the name of the environment, provide description and choose <strong>Kubernetes</strong> as a resource and click Next.</p>
<p><img alt="Environment configuration" src="../img/multi-stage-yaml-pipeline-configuration-003.jpg" /></p>
<p>In next window choose subscription and AKS cluster which you want to add for specific environment. Define also namespace which should be used and click validate and create.</p>
<p><img alt="AKS cluster setup" src="../img/multi-stage-yaml-pipeline-configuration-004.jpg" /></p>
<p>Once it's done you should see AKS cluster added to environment. Repeat above steps if you want to add additional AKS clusters.</p>
<p><img alt="AKS environments" src="../img/multi-stage-yaml-pipeline-configuration-005.jpg" /></p>
<p>You should also configure variable group which should look like on below picture.
Of course values for environments and service connections should be adjusted to your configuration.</p>
<p><img alt="AKSVariableGroup" src="../img/multi-stage-yaml-pipeline-configuration-006.jpg" /></p>
<h2 id="yaml-configuration">YAML configuration</h2>
<p>Once we have environment configured we can start with configuration of YAML files.</p>
<h3 id="build-configuration">Build configuration</h3>
<p>As a first step we should define build pipeline <strong>azure-pipelines.yaml</strong>.
In our scenario it will be quite easy and yaml will look like this:</p>
<div class="codehilite"><pre><span></span><code><span class="nt">variables</span><span class="p">:</span>
<span class="p p-Indicator">-</span> <span class="nt">group</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">AKSBuildVariables</span>

<span class="nt">stages</span><span class="p">:</span>
<span class="p p-Indicator">-</span> <span class="nt">stage</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Build</span>
  <span class="nt">jobs</span><span class="p">:</span>
  <span class="p p-Indicator">-</span> <span class="nt">job</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Build</span>
    <span class="nt">pool</span><span class="p">:</span>
      <span class="nt">vmImage</span><span class="p">:</span> <span class="s">&#39;windows-2019&#39;</span> 
    <span class="nt">continueOnError</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
    <span class="nt">steps</span><span class="p">:</span>
    <span class="p p-Indicator">-</span> <span class="nt">checkout</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">self</span>
      <span class="nt">clean</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
      <span class="nt">persistCredentials</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span> 
    <span class="p p-Indicator">-</span> <span class="nt">task</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">PublishPipelineArtifact@1</span>
      <span class="nt">inputs</span><span class="p">:</span>
        <span class="nt">path</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">$(System.DefaultWorkingDirectory)</span>
        <span class="nt">artifact</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">yaml</span>

<span class="p p-Indicator">-</span> <span class="nt">template</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">deploy-to-all-stages.yaml</span>
</code></pre></div>


<p>As a variables we are using variable group defined in prerequisites step.
It will be used for gathering all sensitive data in encrypted way.</p>
<p>The main thing we will do here is publish all files as artifacts of this build.</p>
<p>At the end of above yaml there is template <strong>deploy-to-all-stages.yaml</strong> which will be used for caling specific stages.</p>
<h3 id="deploy-to-all-stagesyaml-configuration">deploy-to-all-stages.yaml configuration</h3>
<div class="codehilite"><pre><span></span><code><span class="nt">stages</span><span class="p">:</span>
<span class="p p-Indicator">-</span> <span class="nt">template</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">deployment-stage.yaml</span>
  <span class="nt">parameters</span><span class="p">:</span>
    <span class="nt">STAGE_NAME</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">DEV</span>
    <span class="nt">STAGE_ENVIRONMENT</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">$(DEV_ENVIRONMENT_NAME)</span>
    <span class="nt">STAGE_K8S_SERVICE_ENDPOINT</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">$(DEV_CLUSTER_SERVICE_CONNECTION_NAME)</span>

<span class="p p-Indicator">-</span> <span class="nt">template</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">deployment-stage.yaml</span>
  <span class="nt">parameters</span><span class="p">:</span>
    <span class="nt">STAGE_NAME</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">PROD</span>
    <span class="nt">STAGE_ENVIRONMENT</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">$(PROD_ENVIRONMENT_NAME)</span>
    <span class="nt">STAGE_K8S_SERVICE_ENDPOINT</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">$(PROD_CLUSTER_SERVICE_CONNECTION_NAME)</span>
</code></pre></div>


<p>As you can see here we are specifing configuration for each stage.
We can use different deployment template depends on scenario we want to implement.</p>
<p>To make it easier I will use same template file for both stages, only input parameters will be different.
Parameters will be taken directly from variable group defined in build part.
If you want to use different variable group for each environment you can define them as well on deployment template level.</p>
<p>Once you have file with stages defined, it's time to create main deployment template.
In our case it will be called <strong>deployment-stage.yaml</strong>.</p>
<h3 id="deployment-stageyaml-configuration">deployment-stage.yaml configuration</h3>
<div class="codehilite"><pre><span></span><code><span class="nt">parameters</span><span class="p">:</span>
  <span class="nt">STAGE_NAME</span><span class="p">:</span> <span class="s">&#39;&#39;</span>
  <span class="nt">STAGE_ENVIRONMENT</span><span class="p">:</span> <span class="s">&#39;&#39;</span>
  <span class="nt">STAGE_K8S_SERVICE_ENDPOINT</span><span class="p">:</span> <span class="s">&#39;&#39;</span>

<span class="nt">stages</span><span class="p">:</span>
<span class="p p-Indicator">-</span> <span class="nt">stage</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">${{ parameters.STAGE_NAME }}</span>
  <span class="nt">jobs</span><span class="p">:</span>  
  <span class="p p-Indicator">-</span> <span class="nt">deployment</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">SetupCluster</span>
    <span class="nt">pool</span><span class="p">:</span> 
      <span class="nt">vmImage</span><span class="p">:</span> <span class="s">&#39;ubuntu-latest&#39;</span>
    <span class="nt">environment</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">${{ parameters.STAGE_ENVIRONMENT }}</span>
    <span class="nt">strategy</span><span class="p">:</span> 
      <span class="nt">runOnce</span><span class="p">:</span>
        <span class="nt">deploy</span><span class="p">:</span>
          <span class="nt">steps</span><span class="p">:</span>
          <span class="p p-Indicator">-</span> <span class="nt">task</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">DownloadPipelineArtifact@2</span>
            <span class="nt">inputs</span><span class="p">:</span>
              <span class="nt">artifactName</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">yaml</span>
              <span class="nt">targetPath</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">$(Build.SourcesDirectory)/yaml</span>

          <span class="p p-Indicator">-</span> <span class="nt">task</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">HelmInstaller@1</span>
            <span class="nt">inputs</span><span class="p">:</span>
              <span class="nt">helmVersionToInstall</span><span class="p">:</span> <span class="s">&#39;2.14.3&#39;</span>

          <span class="p p-Indicator">-</span> <span class="nt">task</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Kubernetes@1</span>
            <span class="nt">displayName</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Configure custom role</span>
            <span class="nt">inputs</span><span class="p">:</span>
              <span class="nt">connectionType</span><span class="p">:</span> <span class="s">&#39;Kubernetes</span><span class="nv"> </span><span class="s">Service</span><span class="nv"> </span><span class="s">Connection&#39;</span>
              <span class="nt">kubernetesServiceEndpoint</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">${{ parameters.STAGE_K8S_SERVICE_ENDPOINT }}</span>
              <span class="nt">command</span><span class="p">:</span> <span class="s">&#39;apply&#39;</span>
              <span class="nt">arguments</span><span class="p">:</span> <span class="s">&#39;-f</span><span class="nv"> </span><span class="s">$(Build.SourcesDirectory)/yaml/configure-custom-role.yaml.yaml&#39;</span>

          <span class="p p-Indicator">-</span> <span class="nt">task</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Bash@3</span>
            <span class="nt">displayName</span><span class="p">:</span> <span class="s">&quot;Repo</span><span class="nv"> </span><span class="s">add</span><span class="nv"> </span><span class="s">nginx&quot;</span>
            <span class="nt">inputs</span><span class="p">:</span>
              <span class="nt">targetType</span><span class="p">:</span> <span class="s">&#39;inline&#39;</span>
              <span class="nt">script</span><span class="p">:</span> <span class="s">&#39;helm</span><span class="nv"> </span><span class="s">repo</span><span class="nv"> </span><span class="s">add</span><span class="nv"> </span><span class="s">nginx-stable</span><span class="nv"> </span><span class="s">https://helm.nginx.com/stable&#39;</span>

          <span class="p p-Indicator">-</span> <span class="nt">task</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Bash@3</span>
            <span class="nt">displayName</span><span class="p">:</span> <span class="s">&quot;Repo</span><span class="nv"> </span><span class="s">update&quot;</span>
            <span class="nt">inputs</span><span class="p">:</span>
              <span class="nt">targetType</span><span class="p">:</span> <span class="s">&#39;inline&#39;</span>
              <span class="nt">script</span><span class="p">:</span> <span class="s">&#39;helm</span><span class="nv"> </span><span class="s">repo</span><span class="nv"> </span><span class="s">update&#39;</span>  
</code></pre></div>


<p>Deployment stage template starts with input parameters. 
Values of those parameters are taken from <strong>deploy-to-all-stages.yaml</strong> separately for each stage.
To use input parameters please fallow syntax like below:</p>
<p><strong>${{parameters.INPUT_PARAMETER }}</strong></p>
<p>Next we are defining vm image on which deployment will take place and main configuration is done.</p>
<p>In deploy section we provide tasks which should be used in our release.</p>
<p>In our case we will perform following operations:
- Download artifacts from build
- Install Helm tool
- Create a custom role and assign it to group system:serviceaccounts
- Download nginx (without installation) to repository on AKS node
- Update repository on AKS node</p>
<p>For third and last task we need additional yaml file 
to be added to our GIT reposiotry.</p>
<ul>
<li><strong>configure-custom-role.yaml</strong>  </li>
</ul>
<div class="codehilite"><pre><span></span><code><span class="nt">kind</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Role</span>
<span class="nt">apiVersion</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">rbac.authorization.k8s.io/v1</span>
<span class="nt">metadata</span><span class="p">:</span>
  <span class="nt">namespace</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">default</span>
  <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">azure-devops-deploy-role</span>
<span class="nt">rules</span><span class="p">:</span>
<span class="p p-Indicator">-</span> <span class="nt">apiGroups</span><span class="p">:</span> <span class="p p-Indicator">[</span><span class="s">&quot;&quot;</span><span class="p p-Indicator">,</span> <span class="s">&quot;extensions&quot;</span><span class="p p-Indicator">,</span> <span class="s">&quot;apps&quot;</span><span class="p p-Indicator">]</span>
  <span class="nt">resources</span><span class="p">:</span> <span class="p p-Indicator">[</span><span class="s">&quot;deployments&quot;</span><span class="p p-Indicator">,</span> <span class="s">&quot;replicasets&quot;</span><span class="p p-Indicator">,</span> <span class="s">&quot;pods&quot;</span><span class="p p-Indicator">,</span> <span class="s">&quot;services&quot;</span><span class="p p-Indicator">]</span>
  <span class="nt">verbs</span><span class="p">:</span> <span class="p p-Indicator">[</span><span class="s">&quot;get&quot;</span><span class="p p-Indicator">,</span> <span class="s">&quot;list&quot;</span><span class="p p-Indicator">,</span> <span class="s">&quot;watch&quot;</span><span class="p p-Indicator">,</span> <span class="s">&quot;create&quot;</span><span class="p p-Indicator">,</span> <span class="s">&quot;update&quot;</span><span class="p p-Indicator">,</span> <span class="s">&quot;patch&quot;</span><span class="p p-Indicator">,</span> <span class="s">&quot;delete&quot;</span><span class="p p-Indicator">]</span>
<span class="nn">---</span>
<span class="nt">kind</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">RoleBinding</span>
<span class="nt">apiVersion</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">rbac.authorization.k8s.io/v1</span>
<span class="nt">metadata</span><span class="p">:</span>
  <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">azure-devops-deploy-manager</span>
  <span class="nt">namespace</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">default</span>
<span class="nt">subjects</span><span class="p">:</span>
<span class="p p-Indicator">-</span> <span class="nt">kind</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Group</span>
  <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">system:serviceaccounts</span>
  <span class="nt">apiGroup</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">rbac.authorization.k8s.io</span>
<span class="nt">roleRef</span><span class="p">:</span>
  <span class="nt">kind</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Role</span>
  <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">azure-devops-deploy-role</span>
  <span class="nt">apiGroup</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">rbac.authorization.k8s.io</span>
</code></pre></div>


<h3 id="linking-a-build-yaml-file-in-azure-devops">Linking a build yaml file in Azure DevOps</h3>
<p>Ok, once we have everything prepared your GIT repo should looks like on below picture.</p>
<p><img alt="AKS git repo" src="../img/multi-stage-yaml-pipeline-configuration-007.jpg" /></p>
<p>Let's go now to Azure DevOps and configure pipeline.</p>
<p>Go to Pipeline-&gt;Create Pipeline-&gt; Azure Repos Git -&gt; Select name of your repo -&gt; Exisitng Azure Pipelines Yaml File -&gt; Select azure-pipelines.yaml from your GIT repo and click on Run button.</p>
<p><img alt="AKS pipeline" src="../img/gif/multi-stage-yaml-pipeline-configuration-008.gif" /></p>
<p>As a result you should see that Multi-Stage YAML pipeline apply changes to all your clusters.</p>
<p><img alt="Multi-Stage YAML result" src="../img/multi-stage-yaml-pipeline-configuration-009.jpg" /></p>
<h2 id="conclusion">Conclusion</h2>
<p>In my example I shared with you scenario for AKS cluster configuration. </p>
<p>Similar scenarios for deployment with ARM template usage can be done similar way without going deep dive into envrionments part.</p>
<p>Just wanted to show you how awesome are multi-stage YAML pipelines, hope that I ecourage you to use them ;)</p>
                
                  
                
                
              
              
                


  <h2 id="__comments">Comments</h2>
  <div id="disqus_thread"></div>
  <script>
    var disqus_config = function () {
      this.page.url = "https://automate.guru/multi-stage-yaml-pipeline-configuration/";
      this.page.identifier =
        "multi-stage-yaml-pipeline-configuration/";
    };
    (function() {
      var d = document, s = d.createElement("script");
      s.src = "//automate-guru.disqus.com/embed.js";
      s.setAttribute("data-timestamp", +new Date());
      (d.head || d.body).appendChild(s);
    })();
  </script>

              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="../security-and-compliance-as-a-code-azure-policy-tdd/" title="Security And Compliance As A Code Azure Policy TDD" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Security And Compliance As A Code Azure Policy TDD
              </span>
            </div>
          </a>
        
        
          <a href="../azure-policy-continous-integration/" title="Continous Inspection For Azure Policy" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                Continous Inspection For Azure Policy
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        powered by
        <a href="https://www.mkdocs.org" target="_blank" rel="noopener">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs</a>
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../assets/javascripts/application.c33a9706.js"></script>
      
      <script>app.initialize({version:"1.1",url:{base:".."}})</script>
      
    
  </body>
</html>