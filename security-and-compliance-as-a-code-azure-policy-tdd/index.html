



<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
      
        <link rel="canonical" href="https://automate.guru/security-and-compliance-as-a-code-azure-policy-tdd/">
      
      
      
        <meta name="lang:clipboard.copy" content="Copy to clipboard">
      
        <meta name="lang:clipboard.copied" content="Copied to clipboard">
      
        <meta name="lang:search.language" content="en">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="No matching documents">
      
        <meta name="lang:search.result.one" content="1 matching document">
      
        <meta name="lang:search.result.other" content="# matching documents">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.1, mkdocs-material-4.6.3">
    
    
      
        <title>Security And Compliance As A Code - TDD - Automation Bible</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/application.adb8469c.css">
      
        <link rel="stylesheet" href="../assets/stylesheets/application-palette.a8b3c06d.css">
      
      
        
        
        <meta name="theme-color" content="#2196f3">
      
    
    
      <script src="../assets/javascripts/modernizr.86422ebf.js"></script>
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CUbuntu+Mono&display=fallback">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Ubuntu Mono","Courier New",Courier,monospace}</style>
      
    
    <link rel="stylesheet" href="../assets/fonts/material-icons.css">
    
    
    
      
        
<script>
  window.ga = window.ga || function() {
    (ga.q = ga.q || []).push(arguments)
  }
  ga.l = +new Date
  /* Setup integration and send page view */
  ga("create", "UA-160963982-1", "auto")
  ga("set", "anonymizeIp", true)
  ga("send", "pageview")
  /* Register handler to log search on blur */
  document.addEventListener("DOMContentLoaded", () => {
    if (document.forms.search) {
      var query = document.forms.search.query
      query.addEventListener("blur", function() {
        if (this.value) {
          var path = document.location.pathname;
          ga("send", "pageview", path + "?q=" + this.value)
        }
      })
    }
  })
</script>
<script async src="https://www.google-analytics.com/analytics.js"></script>
      
    
    
  </head>
  
    
    
    <body dir="ltr" data-md-color-primary="blue" data-md-color-accent="blue">
  
    <svg class="md-svg">
      <defs>
        
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
    
      <a href="#security-and-compliance-as-a-code-azure-policy-test-driven-development" tabindex="0" class="md-skip">
        Skip to content
      </a>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href="https://automate.guru/" title="Automation Bible" aria-label="Automation Bible" class="md-header-nav__button md-logo">
          
            <i class="md-icon"></i>
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            <span class="md-header-nav__topic">
              Automation Bible
            </span>
            <span class="md-header-nav__topic">
              
                Security And Compliance As A Code - TDD
              
            </span>
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
          
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" aria-label="search" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
        
      </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
      <main class="md-main" role="main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href="https://automate.guru/" title="Automation Bible" class="md-nav__button md-logo">
      
        <i class="md-icon"></i>
      
    </a>
    Automation Bible
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-1" type="checkbox" id="nav-1">
    
    <label class="md-nav__link" for="nav-1">
      Azure DevOps
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-1">
        Azure DevOps
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../azure-devops-audit-logs-forwarding/" title="Audit Logs Forwarder" class="md-nav__link">
      Audit Logs Forwarder
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../multi-stage-yaml-pipeline-configuration/" title="Multi-Stage YAML Pipeline Configuration" class="md-nav__link">
      Multi-Stage YAML Pipeline Configuration
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../universal-arm-deployment-script" title="Universal ARM Template Deployment Script" class="md-nav__link">
      Universal ARM Template Deployment Script
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../azure-lighthouse-configuration/" title="Azure Lighthouse Configuration" class="md-nav__link">
      Azure Lighthouse Configuration
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3" type="checkbox" id="nav-3">
    
    <label class="md-nav__link" for="nav-3">
      PowerShell
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-3">
        PowerShell
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../powershell-web-browser-automation/" title="Web-Based Automation With Selenium" class="md-nav__link">
      Web-Based Automation With Selenium
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../copy-database-between-stages/" title="Copy Azure database between stages" class="md-nav__link">
      Copy Azure database between stages
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../automatic-certificate-generation-aks/" title="Automatic Certificate Generation for AKS" class="md-nav__link">
      Automatic Certificate Generation for AKS
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-6" type="checkbox" id="nav-6">
    
    <label class="md-nav__link" for="nav-6">
      Azure Management Group
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-6">
        Azure Management Group
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../management-group-best-practises/" title="Hierarchy Best Practises" class="md-nav__link">
      Hierarchy Best Practises
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../deploy-management-group-hierarchy" title="Deploy As a Code" class="md-nav__link">
      Deploy As a Code
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-7" type="checkbox" id="nav-7" checked>
    
    <label class="md-nav__link" for="nav-7">
      Azure Policy/ Compliance
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-7">
        Azure Policy/ Compliance
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        Security And Compliance As A Code - TDD
      </label>
    
    <a href="./" title="Security And Compliance As A Code - TDD" class="md-nav__link md-nav__link--active">
      Security And Compliance As A Code - TDD
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#who-is-involved" class="md-nav__link">
    'Who' is involved?
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#why-develop-automatic-testing-for-azure-policy-its-faster-and-more-reliable" class="md-nav__link">
    Why develop automatic testing for Azure Policy? It's faster and more reliable.
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#test-driven-development-process" class="md-nav__link">
    Test-Driven Development Process
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#show-me-that-in-action" class="md-nav__link">
    Show me that in action.
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#more-details" class="md-nav__link">
    More details
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#test-procedure" class="md-nav__link">
    Test procedure
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#azure-resource-group-deployment-validation-function" class="md-nav__link">
    Azure Resource Group deployment validation function
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#what-is-valid" class="md-nav__link">
    What is valid?
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#resource-group-creation-request-must-be" class="md-nav__link">
    Resource group creation request must be:
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#lets-run-pester-tests-locally-before-applying-any-azure-policy" class="md-nav__link">
    Let's run Pester tests locally before applying any Azure Policy
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#continuous-inspection-process" class="md-nav__link">
    Continuous Inspection Process
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#author" class="md-nav__link">
    Author
  </a>
  
</li>
      
      
      
      
      
        <li class="md-nav__item">
          <a href="#__comments" class="md-nav__link md-nav__link--active">
            Comments
          </a>
        </li>
      
    </ul>
  
</nav>
    
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../azure-policy-continous-integration/" title="Continous Inspection For Azure Policy" class="md-nav__link">
      Continous Inspection For Azure Policy
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#who-is-involved" class="md-nav__link">
    'Who' is involved?
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#why-develop-automatic-testing-for-azure-policy-its-faster-and-more-reliable" class="md-nav__link">
    Why develop automatic testing for Azure Policy? It's faster and more reliable.
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#test-driven-development-process" class="md-nav__link">
    Test-Driven Development Process
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#show-me-that-in-action" class="md-nav__link">
    Show me that in action.
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#more-details" class="md-nav__link">
    More details
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#test-procedure" class="md-nav__link">
    Test procedure
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#azure-resource-group-deployment-validation-function" class="md-nav__link">
    Azure Resource Group deployment validation function
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#what-is-valid" class="md-nav__link">
    What is valid?
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#resource-group-creation-request-must-be" class="md-nav__link">
    Resource group creation request must be:
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#lets-run-pester-tests-locally-before-applying-any-azure-policy" class="md-nav__link">
    Let's run Pester tests locally before applying any Azure Policy
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#continuous-inspection-process" class="md-nav__link">
    Continuous Inspection Process
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#author" class="md-nav__link">
    Author
  </a>
  
</li>
      
      
      
      
      
        <li class="md-nav__item">
          <a href="#__comments" class="md-nav__link md-nav__link--active">
            Comments
          </a>
        </li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                
                <h1 id="security-and-compliance-as-a-code-azure-policy-test-driven-development">Security and Compliance as a Code: Azure Policy Test-Driven Development</h1>
<p><img alt="Wardley Map of Security Skills required by Industry" src="https://miro.medium.com/max/1400/1*zQtoY13K2DnU3GvaCYVTRw.png" /></p>
<p>According to <a href="https://medium.com/@marioplatt/security-for-the-2020s-the-skills-and-talent-problem-cc921533850f">Wardley Map of Security Skills required by Industry</a> Security and Compliance as a Code is now in Genesis. There can be no more exciting area to dive in. </p>
<p>Generally speaking, we're inheriting more and more good practices known for years in the software development world. </p>
<ul>
<li>
<p>We've already adopted using <strong>source control repository</strong> to store our script and declarative definitions of our infrastructures. </p>
</li>
<li>
<p>New tools are providing the capability to do static code analysis for non-classic programming languages. </p>
</li>
<li>
<p>Infrastructure deployment is now a <strong>natural part of CD</strong> processes. </p>
</li>
<li>
<p>Azure Marketplace is a place where you can find many tools supporting mentioned. What about the future? Let's start by using <strong>test-driven development</strong> in the process of <strong>providing consistency</strong> to our Azure subscriptions using <strong>Azure Policy</strong>.</p>
</li>
</ul>
<h3 id="who-is-involved">'Who' is involved?</h3>
<ul>
<li>
<p>Pester Powershell module</p>
</li>
<li>
<p>Az.Resources Powershell module</p>
</li>
<li>
<p>Azure Policy service</p>
</li>
</ul>
<h2 id="why-develop-automatic-testing-for-azure-policy-its-faster-and-more-reliable">Why develop automatic testing for Azure Policy? It's faster and more reliable.</h2>
<ol>
<li>
<p>You'll find errors earlier. Therefore, fully implemented, <strong>well-working functionality</strong> will be <strong>delivered faster</strong>!</p>
</li>
<li>
<p>When any new Azure Policy is created, it will be easy to check if current requirements are still adequately implemented. You'll do the next modifications without affright.</p>
</li>
<li>
<p>Finally, it <strong>can be proved</strong> that <strong>tests have been performed</strong>.</p>
</li>
<li>
<p>Are you able to test hundreds of tests in a couple of minutes using Azure Portal? </p>
</li>
</ol>
<h2 id="test-driven-development-process">Test-Driven Development Process</h2>
<ol>
<li>
<p>Implement tests (only this is covered in this article).</p>
</li>
<li>
<p>Implement functionality.</p>
</li>
</ol>
<h2 id="show-me-that-in-action">Show me that in action.</h2>
<p>As always, we want to explain it to you better using a practical use case. So we want to govern Resource Group tagging. Let's say that there are some requirements defined. </p>
<h2 id="more-details">More details</h2>
<table>
<thead>
<tr>
<th>Tag Name</th>
<th>Required?</th>
<th>Description</th>
<th>Example Value</th>
</tr>
</thead>
<tbody>
<tr>
<td>Owner</td>
<td>Yes</td>
<td>Owner's email address</td>
<td><a href="&#109;&#97;&#105;&#108;&#116;&#111;&#58;&#107;&#97;&#109;&#105;&#108;&#64;&#97;&#117;&#116;&#111;&#109;&#97;&#116;&#101;&#46;&#103;&#117;&#114;&#117;">&#107;&#97;&#109;&#105;&#108;&#64;&#97;&#117;&#116;&#111;&#109;&#97;&#116;&#101;&#46;&#103;&#117;&#114;&#117;</a> <a href="&#109;&#97;&#105;&#108;&#116;&#111;&#58;&#97;&#114;&#116;&#117;&#114;&#64;&#97;&#117;&#116;&#111;&#109;&#97;&#116;&#105;&#111;&#110;&#103;&#117;&#114;&#117;&#115;&#46;&#103;&#105;&#116;&#104;&#117;&#98;&#46;&#105;&#111;">&#97;&#114;&#116;&#117;&#114;&#64;&#97;&#117;&#116;&#111;&#109;&#97;&#116;&#105;&#111;&#110;&#103;&#117;&#114;&#117;&#115;&#46;&#103;&#105;&#116;&#104;&#117;&#98;&#46;&#105;&#111;</a></td>
</tr>
<tr>
<td>Environment</td>
<td>Yes</td>
<td>Can be only dev or prod</td>
<td>dev, prod</td>
</tr>
<tr>
<td>BusinessUnit</td>
<td>Yes</td>
<td>Division/Area/Team, all parts must be filled n</td>
<td>itdivision/appsarea/csharpteam</td>
</tr>
<tr>
<td>EndDate</td>
<td>No</td>
<td>Decommissioning date (DDMMYYYY)</td>
<td>29022024</td>
</tr>
<tr>
<td>ItsmRequestId</td>
<td>No</td>
<td>Service Request's ID</td>
<td>sr0001, sr1990</td>
</tr>
</tbody>
</table>
<p>A table and flow chart should be enough for you to understand what we want to achieve. Additional information: tag values must be lowercase, only allowed domains in the email address are 'automate.guru' and 'automationgurus.github.io'.</p>
<p><img alt="Wardley Map of Security Skills required by Industry" src="../img/security-and-compliance-as-a-code-azure-policy-tdd-001.jpg" /></p>
<h3 id="test-procedure">Test procedure</h3>
<ol>
<li>Create hashtable with some valid and invalid values, also put information if a particular tag presence is required.</li>
<li>Assign initiative containing all policies enforcing business requirements at subscription scope.</li>
<li>Wait 30 minutes to be sure that all assignments are applied.</li>
<li>Use Test-Deployment Powershell to validate deployments in scenarios based on input from pt. 1.</li>
<li>Checks results.</li>
</ol>
<h3 id="azure-resource-group-deployment-validation-function">Azure Resource Group deployment validation function</h3>
<p>We need a function that tries to create RG with tags provided by parameters. This function uses a universal ARM Template for deploying multiple RG.</p>
<div class="codehilite"><pre><span></span><code><span class="p">{</span>
    <span class="nt">&quot;$schema&quot;</span><span class="p">:</span> <span class="s2">&quot;https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#&quot;</span><span class="p">,</span>
    <span class="nt">&quot;contentVersion&quot;</span><span class="p">:</span> <span class="s2">&quot;1.0.0.0&quot;</span><span class="p">,</span>
    <span class="nt">&quot;apiProfile&quot;</span><span class="p">:</span> <span class="s2">&quot;2019-04-01&quot;</span><span class="p">,</span>
    <span class="nt">&quot;parameters&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">&quot;resourceGroups&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;array&quot;</span><span class="p">,</span>
            <span class="nt">&quot;metadata&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="nt">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;Resource groups definition&quot;</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">},</span>
    <span class="nt">&quot;resources&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">{</span>
            <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;Microsoft.Resources/resourceGroups&quot;</span><span class="p">,</span>
            <span class="nt">&quot;apiVersion&quot;</span><span class="p">:</span> <span class="s2">&quot;2019-10-01&quot;</span><span class="p">,</span>

            <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;[parameters(&#39;resourceGroups&#39;)[copyIndex(&#39;rgCopy&#39;)].name]&quot;</span><span class="p">,</span>
            <span class="nt">&quot;location&quot;</span><span class="p">:</span> <span class="s2">&quot;[parameters(&#39;resourceGroups&#39;)[copyIndex(&#39;rgCopy&#39;)].location]&quot;</span><span class="p">,</span>
            <span class="nt">&quot;tags&quot;</span><span class="p">:</span> <span class="s2">&quot;[parameters(&#39;resourceGroups&#39;)[copyIndex(&#39;rgCopy&#39;)].tags]&quot;</span><span class="p">,</span>

            <span class="nt">&quot;properties&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="p">},</span>

            <span class="nt">&quot;copy&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;rgCopy&quot;</span><span class="p">,</span>
                <span class="nt">&quot;count&quot;</span><span class="p">:</span> <span class="s2">&quot;[length(parameters(&#39;resourceGroups&#39;))]&quot;</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">]</span>
<span class="p">}</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="k">function</span> <span class="n">Validate-ResourceGroupDeployment</span> <span class="p">(</span><span class="nv">$Tags</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$deploymentParameters</span> <span class="p">=</span> <span class="p">@{</span>
        <span class="n">TemplateFile</span>            <span class="p">=</span> <span class="s1">&#39;.\ResourceGroups.json&#39;</span>
        <span class="n">TemplateParameterObject</span> <span class="p">=</span> <span class="p">@{</span>
            <span class="n">resourceGroups</span> <span class="p">=</span> <span class="p">@(</span> 
                <span class="p">@{</span>
                    <span class="n">name</span>     <span class="p">=</span> <span class="s2">&quot;rg-tagtest-001&quot;</span>
                    <span class="n">location</span> <span class="p">=</span> <span class="s2">&quot;eastus2&quot;</span>
                    <span class="n">tags</span>     <span class="p">=</span> <span class="nv">$Tags</span>
                <span class="p">}</span>
            <span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="p">(</span><span class="nb">Test-AzDeployment</span> <span class="nv">@deploymentParameters</span> <span class="n">-Location</span> <span class="s1">&#39;eastus2&#39;</span> <span class="p">)</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="what-is-valid">What is valid?</h3>
<p>Here is a list of our test cases in hashtable form. It contains information about whether the tag is required. Also, some valid and invalid values are provided. Try to be tricky as much as you can during providing example wrong values. For example:</p>
<ul>
<li>
<p>29<sup>th</sup> o February :)</p>
</li>
<li>
<p>empty values</p>
</li>
<li>
<p>uppercase values</p>
</li>
<li>
<p>omitting one of the values (this is difficult to validate, however, don't worry, we'll write an article about advanced Azure Policy development)</p>
</li>
</ul>
<div class="codehilite"><pre><span></span><code><span class="nv">$properTags</span> <span class="p">=</span> <span class="p">@{</span>
    <span class="s2">&quot;Owner&quot;</span> <span class="p">=</span> <span class="s1">&#39;kamil@automate.guru&#39;</span>
    <span class="s2">&quot;Environment&quot;</span>       <span class="p">=</span> <span class="s1">&#39;dev&#39;</span>
    <span class="s2">&quot;BusinessUnit&quot;</span>        <span class="p">=</span> <span class="s1">&#39;itdivision/appsarea/csharpteam&#39;</span>
<span class="p">}</span>

<span class="nv">$tagValuesValidationInput</span> <span class="p">=</span> <span class="p">@(</span>
    <span class="p">@{</span>
        <span class="n">TagName</span>      <span class="p">=</span> <span class="s1">&#39;Owner&#39;</span>
        <span class="n">State</span>        <span class="p">=</span> <span class="s1">&#39;Optional&#39;</span>
        <span class="n">ProperValues</span> <span class="p">=</span> <span class="p">@(</span>
            <span class="s1">&#39;kamil@automate.guru&#39;</span>
            <span class="s1">&#39;artur@automationgurus.github.io&#39;</span>
        <span class="p">)</span>
        <span class="n">WrongValues</span>  <span class="p">=</span> <span class="p">@(</span>
            <span class="s1">&#39;kamilautomate.guru&#39;</span>
            <span class="s1">&#39;@automate.guru&#39;</span>
            <span class="s1">&#39;&#39;</span>
            <span class="s1">&#39;somemone@&#39;</span>
            <span class="s1">&#39;somemone@.com&#39;</span>
            <span class="s1">&#39;somemone@.&#39;</span>
            <span class="s1">&#39;somemone@automate.&#39;</span>
        <span class="p">)</span>
    <span class="p">}</span>
    <span class="p">@{</span>
        <span class="n">TagName</span>      <span class="p">=</span> <span class="s1">&#39;Environment&#39;</span>
        <span class="n">State</span>        <span class="p">=</span> <span class="s1">&#39;Required&#39;</span>
        <span class="n">ProperValues</span> <span class="p">=</span> <span class="p">@(</span>
            <span class="s1">&#39;dev&#39;</span>
            <span class="s1">&#39;prod&#39;</span>
        <span class="p">)</span>
        <span class="n">WrongValues</span>  <span class="p">=</span> <span class="p">@(</span>
            <span class="s1">&#39;&#39;</span>
            <span class="s1">&#39;uat&#39;</span>
            <span class="s1">&#39;DEV&#39;</span>
        <span class="p">)</span>
    <span class="p">}</span>
    <span class="p">@{</span>
        <span class="n">TagName</span>      <span class="p">=</span> <span class="s1">&#39;BusinessUnit&#39;</span>
        <span class="n">State</span>        <span class="p">=</span> <span class="s1">&#39;Required&#39;</span>
        <span class="n">ProperValues</span> <span class="p">=</span> <span class="p">@(</span>
            <span class="s1">&#39;itdivision/appsarea/csharpteam&#39;</span>
        <span class="p">)</span>
        <span class="n">WrongValues</span>  <span class="p">=</span> <span class="p">@(</span>
            <span class="s1">&#39;/appsarea/csharpteam&#39;</span>
            <span class="s1">&#39;itdivision//csharpteam&#39;</span>
            <span class="s1">&#39;itdivision/appsarea/&#39;</span>
            <span class="s1">&#39;itdivision/appsarea/Csharpteam&#39;</span>
            <span class="s1">&#39;itdivision/Appsarea/csharpteam&#39;</span>
            <span class="s1">&#39;Itdivision/appsarea/csharpteam&#39;</span>
            <span class="s1">&#39;&#39;</span>
            <span class="s1">&#39;//&#39;</span>
            <span class="s1">&#39;/&#39;</span>
        <span class="p">)</span>
    <span class="p">}</span>
    <span class="p">@{</span>
        <span class="n">TagName</span>      <span class="p">=</span> <span class="s1">&#39;ItsmRequestId&#39;</span>
        <span class="n">State</span>        <span class="p">=</span> <span class="s1">&#39;Optional&#39;</span>
        <span class="n">ProperValues</span> <span class="p">=</span> <span class="p">@(</span>
            <span class="s1">&#39;sr1990&#39;</span>
        <span class="p">)</span>
        <span class="n">WrongValues</span>  <span class="p">=</span> <span class="p">@(</span>
            <span class="s1">&#39;&#39;</span>  
            <span class="s1">&#39;SR1990&#39;</span>
            <span class="s1">&#39;1990&#39;</span>
        <span class="p">)</span>
    <span class="p">}</span>
    <span class="p">@{</span>
        <span class="n">TagName</span>      <span class="p">=</span> <span class="s1">&#39;EndDate&#39;</span>
        <span class="n">State</span>        <span class="p">=</span> <span class="s1">&#39;Optional&#39;</span>
        <span class="n">ProperValues</span> <span class="p">=</span> <span class="p">@(</span>
            <span class="s1">&#39;11062020&#39;</span>
            <span class="s1">&#39;02292024&#39;</span>
            <span class="s1">&#39;06012020&#39;</span>
        <span class="p">)</span>
        <span class="n">WrongValues</span>  <span class="p">=</span> <span class="p">@(</span>
            <span class="s1">&#39;11&#39;</span>
            <span class="s1">&#39;&#39;</span>
            <span class="s1">&#39;99999999&#39;</span>
            <span class="s1">&#39;13012020&#39;</span>
            <span class="s1">&#39;11322020&#39;</span>
            <span class="s1">&#39;02292021&#39;</span>
        <span class="p">)</span>
    <span class="p">}</span>
<span class="p">)</span>
</code></pre></div>

<h3 id="resource-group-creation-request-must-be">Resource group creation request must be:</h3>
<ul>
<li>
<p><strong>allowed</strong> when only <strong>required tags</strong> have <strong>proper values</strong> and are provided</p>
</li>
<li>
<p><strong>denied</strong> if any <strong>mandatory tag</strong> is <strong>not there</strong></p>
</li>
<li>
<p><strong>denied</strong> if any <strong>mandatory tag</strong> has an <strong>invalid value</strong></p>
</li>
<li>
<p><strong>allowed</strong> when required tags are present and have valid values and <strong>optional parameter</strong> have a <strong>proper value</strong></p>
</li>
<li>
<p><strong>denied</strong> when the <strong>optional tag</strong> has a <strong>wrong value</strong></p>
</li>
</ul>
<div class="codehilite"><pre><span></span><code><span class="n">Describe</span> <span class="s2">&quot;Tagging Initiative&quot;</span> <span class="p">{</span>
    <span class="n">It</span> <span class="s2">&quot;allows RG creation when required tags are provided&quot;</span> <span class="p">{</span>
        <span class="nv">$validationResult</span> <span class="p">=</span> <span class="n">Validate-ResourceGroupDeployment</span> <span class="n">-Tags</span> <span class="nv">$properTags</span>
        <span class="nv">$validationResult</span> <span class="p">|</span> <span class="n">Should</span> <span class="n">-BeNullOrEmpty</span>
    <span class="p">}</span>

    <span class="nv">$requiredTagNames</span> <span class="p">=</span> <span class="p">(</span><span class="nv">$tagValuesValidationInput</span> <span class="p">|</span> <span class="nb">Where-Object</span> <span class="n">-Property</span> <span class="n">State</span> <span class="o">-EQ</span> <span class="s1">&#39;Required&#39;</span><span class="p">).</span><span class="n">TagName</span>

    <span class="k">foreach</span> <span class="p">(</span><span class="nv">$tagName</span> <span class="k">in</span> <span class="nv">$requiredTagNames</span> <span class="p">)</span> <span class="p">{</span>
        <span class="n">It</span> <span class="s2">&quot;denies RG creation when required tag &#39;</span><span class="p">$(</span> <span class="nv">$tagName</span> <span class="p">)</span><span class="s2">&#39; is missing&quot;</span> <span class="p">{</span>
            <span class="nv">$tags</span> <span class="p">=</span> <span class="nv">$properTags</span><span class="p">.</span><span class="n">Clone</span><span class="p">()</span> 
            <span class="nv">$tags</span><span class="p">.</span><span class="n">Remove</span><span class="p">(</span><span class="nv">$tagName</span><span class="p">)</span>
            <span class="nv">$validationResult</span> <span class="p">=</span> <span class="n">Validate-ResourceGroupDeployment</span> <span class="n">-Tags</span> <span class="nv">$tags</span>
            <span class="nv">$validationResult</span> <span class="p">|</span> <span class="n">Should</span> <span class="o">-Not</span> <span class="n">-BeNullOrEmpty</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">foreach</span> <span class="p">(</span><span class="nv">$item</span> <span class="k">in</span> <span class="nv">$tagValuesValidationInput</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">foreach</span> <span class="p">(</span><span class="nv">$value</span> <span class="k">in</span> <span class="nv">$item</span><span class="p">.</span><span class="n">ProperValues</span> <span class="p">)</span> <span class="p">{</span>
            <span class="n">It</span> <span class="s2">&quot;allows RG creation when tag &#39;</span><span class="p">$(</span> <span class="nv">$item</span><span class="p">.</span><span class="n">TagName</span> <span class="p">)</span><span class="s2">&#39; equals &#39;</span><span class="p">$(</span> <span class="nv">$value</span> <span class="p">)</span><span class="s2">&#39;&quot;</span> <span class="p">{</span>
                <span class="nv">$tags</span> <span class="p">=</span> <span class="nv">$properTags</span><span class="p">.</span><span class="n">Clone</span><span class="p">()</span> 
                <span class="nv">$tags</span><span class="p">[</span><span class="nv">$item</span><span class="p">.</span><span class="n">TagName</span><span class="p">]</span> <span class="p">=</span> <span class="nv">$value</span> 
                <span class="nv">$validationResult</span> <span class="p">=</span> <span class="n">Validate-ResourceGroupDeployment</span> <span class="n">-Tags</span> <span class="nv">$tags</span>
                <span class="nv">$validationResult</span> <span class="p">|</span> <span class="n">Should</span> <span class="n">-BeNullOrEmpty</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="k">foreach</span> <span class="p">(</span><span class="nv">$value</span> <span class="k">in</span> <span class="nv">$item</span><span class="p">.</span><span class="n">WrongValues</span> <span class="p">)</span> <span class="p">{</span>
            <span class="n">It</span> <span class="s2">&quot;denies RG creation when tag &#39;</span><span class="p">$(</span> <span class="nv">$item</span><span class="p">.</span><span class="n">TagName</span> <span class="p">)</span><span class="s2">&#39; equals &#39;</span><span class="p">$(</span> <span class="nv">$value</span> <span class="p">)</span><span class="s2">&#39;&quot;</span> <span class="p">{</span>
                <span class="nv">$tags</span> <span class="p">=</span> <span class="nv">$properTags</span><span class="p">.</span><span class="n">Clone</span><span class="p">()</span>
                <span class="nv">$tags</span><span class="p">[</span><span class="nv">$item</span><span class="p">.</span><span class="n">TagName</span><span class="p">]</span> <span class="p">=</span> <span class="nv">$value</span> 
                <span class="nv">$validationResult</span> <span class="p">=</span> <span class="n">Validate-ResourceGroupDeployment</span> <span class="n">-Tags</span> <span class="nv">$tags</span>
                <span class="nv">$validationResult</span> <span class="p">|</span> <span class="n">Should</span> <span class="o">-Not</span> <span class="n">-BeNullOrEmpty</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<h2 id="lets-run-pester-tests-locally-before-applying-any-azure-policy">Let's run Pester tests locally before applying any Azure Policy</h2>
<p><img alt="Wardley Map of Security Skills required by Industry" src="../img/security-and-compliance-as-a-code-azure-policy-tdd-002.jpg" /></p>
<p><img alt="Wardley Map of Security Skills required by Industry" src="../img/security-and-compliance-as-a-code-azure-policy-tdd-003.jpg" /></p>
<h2 id="continuous-inspection-process">Continuous Inspection Process</h2>
<p><a href="/azure-policy-continous-integration/">Automated Azure Policy Continous Inspection process implementation with Azure Dev</a></p>
<h2 id="author">Author</h2>
<p><img alt="Kamil Wiecek" src="../img/kamil-wiecek-001.png" /></p>
<p><strong>Kamil Więcek</strong> is twentynine years old IT passionate that will continue to learn, do home projects and practicing new technologies even if he becomes a multimillionaire. 
Big fan of the following sentence: "if you describe a process mentioning someone's name, then it is not automated."</p>
                
                  
                
                
              
              
                


  <h2 id="__comments">Comments</h2>
  <div id="disqus_thread"></div>
  <script>
    var disqus_config = function () {
      this.page.url = "https://automate.guru/security-and-compliance-as-a-code-azure-policy-tdd/";
      this.page.identifier =
        "security-and-compliance-as-a-code-azure-policy-tdd/";
    };
    (function() {
      var d = document, s = d.createElement("script");
      s.src = "//automate-guru.disqus.com/embed.js";
      s.setAttribute("data-timestamp", +new Date());
      (d.head || d.body).appendChild(s);
    })();
  </script>

              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="../management-group-best-practises/" title="Hierarchy Best Practises" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Hierarchy Best Practises
              </span>
            </div>
          </a>
        
        
          <a href="../azure-policy-continous-integration/" title="Continous Inspection For Azure Policy" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                Continous Inspection For Azure Policy
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        powered by
        <a href="https://www.mkdocs.org" target="_blank" rel="noopener">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs</a>
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../assets/javascripts/application.c33a9706.js"></script>
      
      <script>app.initialize({version:"1.1",url:{base:".."}})</script>
      
        <script src="../javascripts/extra.js"></script>
      
    
  </body>
</html>